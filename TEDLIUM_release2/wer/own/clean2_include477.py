import re

# 替换规则：将连接的单词还原为两个词
custom_mappings = {
    "andhow": "and how",
    "andatferst": "and at first",
    "don’t": "do not",
    "everam": "ever am",
    "gaveme": "gave me",
    "howaryou’regoing": "how are you’re going",
    "it’s": "it is",
    "itdoesn’t": "it doesn’t",
    "itwas": "it was",
    "nearto": "near to",
    "ofcourse": "of course",
    "thankyou": "thank you",
    "thatyou": "that you",
    "you’re": "you are",
    "youknow": "you know",
    "andmachines": "and machines",
    "greatgrandparents": "great grandparents",
    "encouragepeople": "encourage people",
    "behindthe": "behind the",
    "commonstance": "common stance",
    "fivebillion": "five billion",
    "deepdives": "deep dives",
    "theunited": "the united",
    "themeabout": "theme about",
    "worldlast": "world last",
    "thehealth": "the health",
    "bottomline": "bottom line",
    "decentpeople": "decent people",
    "magictrick": "magic trick",
    "andcooperation": "and cooperation",
    "maybethat": "maybe that",
    "thateffect": "that effect",
    "justgoing": "just going",
    "nextdecade": "next decade",
    "notbecause": "not because",
    "twoselves": "two selves",
    "thevalues": "the values",
    "broadbacking": "broad backing",
    "backpocket": "back pocket",
    "theninety": "the ninety",
    "andvaluable": "and valuable",
    "theenergy": "the energy",
    "worldsaving": "world saving",
    "themessage": "the message",
    "thepeople": "the people",
    "theopposite": "the opposite",
    "secondgrade": "second grade",
    "justviewing": "just viewing",
    "reportcard": "report card",
    "productionpossible": "production possible",
    "disclosurerules": "disclosure rules",
    "andadventures": "and adventures",
    "justenough": "just enough",
    "burningcoal": "burning coal",
    "andplaying": "and playing",
    "weretaking": "were taking",
    "gamesthan": "games than",
    "theextraordinary": "the extraordinary",
    "whitecolor": "white color",
    "thewireless": "the wireless",
    "manythings": "many things",
    "haveheard": "have heard",
    "southafrica": "south africa",
    "giantfields": "giant fields",
    "filmmaking": "film making",
    "understoodthat": "understood that",
    "experiencingself": "experiencing self",
    "simpletrick": "simple trick",
    "thesedays": "these days",
    "summertime": "summer time",
    "andlikewise": "and likewise",
    "goodeither": "good either",
    "everygrain": "every grain",
    "happinessself": "happiness self",
    "globalcooling": "global cooling",
    "mistakenow": "mistake now",
    "sleeveback": "sleeve back",
    "dicegames": "dice games",
    "withserious": "with serious",
    "andclimate": "and climate",
    "hadtalked": "had talked",
    "abouthappiness": "about happiness",
    "poliodoes": "polio does",
    "secondtrap": "second trap",
    "certaindate": "certain date",
    "newspaperclipping": "newspaper clipping",
    "farmraised": "farm raised",
    "adversityand": "adversity and",
    "justproducers": "just producers",
    "existhardly": "exist hardly",
    "aboutgenetically": "about genetically",
    "withrealistic": "with realistic",
    "dreamteam": "dream team",
    "overspecific": "over specific",
    "arecompletely": "are completely",
    "billionpeople": "billion people",
    "closelook": "close look",
    "thescientist": "the scientist",
    "twopercent": "two percent",
    "thedesire": "the desire",
    "gregariousway": "gregarious way",
    "standback": "stand back",
    "thatseems": "that seems",
    "offnothing": "off nothing",
    "fivehundred": "five hundred",
    "diseaseand": "disease and",
    "medstudents": "med students",
    "thisinvolves": "this involves",
    "thisabsurd": "this absurd",
    "happenfaster": "happen faster",
    "theblueprints": "the blueprints",
    "notenough": "not enough",
    "theradiation": "the radiation",
    "thetechnology": "the technology",
    "differentcharacters": "different characters",
    "fourthings": "four things",
    "effectfor": "effect for",
    "fakebecomes": "fake becomes",
    "barelybroke": "barely broke",
    "otherside": "other side",
    "arerecognizing": "are recognizing",
    "energymiracles": "energy miracles",
    "marchthird": "march third",
    "areliving": "are living",
    "thecorridor": "the corridor",
    "spacemission": "space mission",
    "spacemissions": "space missions",
    "beefcattle": "beef cattle",
    "highlyregulated": "highly regulated",
    "sixhundred": "six hundred",
    "twentyone": "twenty one",
    "foodsystem": "food system",
    "twelvepeople": "twelve people",
    "thepathology": "the pathology",
    "andinterestingly": "and interestingly",
    "theplanet": "the planet",
    "globalscale": "global scale",
    "evenleave": "even leave",
    "theregulator": "the regulator",
    "fishfarming": "fish farming",
    "righthere": "right here",
    "demandproof": "demand proof",
    "comesfrom": "comes from",
    "everychild": "every child",
    "dumbenough": "dumb enough",
    "takingthem": "taking them",
    "talleststructure": "tallest structure",
    "creatureand": "creature and",
    "fromrapidly": "from rapidly",
    "anyonehad": "anyone had",
    "liquidwater": "liquid water",
    "veryimportant": "very important",
    "forgranted": "for granted",
    "darnunlikely": "darn unlikely",
    "schoolwork": "school work",
    "thetitanic": "the titanic",
    "askaround": "ask around",
    "thinkabout": "think about",
    "andrelative": "and relative",
    "therehave": "there have",
    "persianpoet": "persian poet",
    "walkingthe": "walking the",
    "withoutarmed": "without armed",
    "betterthings": "better things",
    "greatbooks": "great books",
    "kingdomwide": "kingdom wide",
    "theexercise": "the exercise",
    "twentyeight": "twenty eight",
    "howshould": "how should",
    "rememberingself": "remembering self",
    "soundlike": "sound like",
    "squaremiles": "square miles",
    "globalaudience": "global audience",
    "fishfarms": "fish farms",
    "theresome": "there some",
    "publicpolicy": "public policy",
    "manyfields": "many fields",
    "straightabout": "straight about",
    "processthey": "process they",
    "whatmight": "what might",
    "fullpercentage": "full percentage",
    "thethings": "the things",
    "pondwater": "pond water",
    "couldthrive": "could thrive",
    "everybodytalks": "everybody talks",
    "thedeadline": "the deadline",
    "plantsgoes": "plants goes",
    "thankthank": "thank thank",
    "theirmost": "their most",
    "somebodyand": "somebody and",
    "townwhere": "town where",
    "himexploding": "him exploding",
    "maybeeven": "maybe even",
    "therenewable": "the renewable",
    "withstudents": "with students",
    "theservices": "the services",
    "althoughthat": "although that",
    "tightsocial": "tight social",
    "samplebelow": "sample below",
    "highschool": "high school",
    "healthcare": "health care",
    "haveexplained": "have explained",
    "everysingle": "every single",
    "grownflesh": "grown flesh",
    "theywould": "they would",
    "thestudio": "the studio",
    "areinvesting": "are investing",
    "argumentthat": "argument that",
    "thatreleasing": "that releasing",
    "theeffects": "the effects",
    "figureout": "figure out",
    "somethinglike": "something like",
    "pullwater": "pull water",
    "thestories": "the stories",
    "shouldyou": "should you",
    "fewpeople": "few people",
    "throughour": "through our",
    "whitepill": "white pill",
    "thereason": "the reason",
    "problemsand": "problems and",
    "havesignificant": "have significant",
    "streetlamps": "street lamps",
    "hotelroom": "hotel room",
    "shocktherapy": "shock therapy",
    "thewinners": "the winners",
    "cansimulate": "can simulate",
    "youactually": "you actually",
    "firstplace": "first place",
    "thethrough": "the through",
    "thetallest": "the tallest",
    "everymonth": "every month",
    "reflectiveself": "reflective self",
    "thecanals": "the canals",
    "helpsthem": "helps them",
    "buildingnests": "building nests",
    "filmdirector": "film director",
    "talkedthem": "talked them",
    "hundredyears": "hundred years",
    "rightaway": "right away",
    "thedoctor": "the doctor",
    "thosesame": "those same",
    "wouldpick": "would pick",
    "everybodywould": "everybody would",
    "getdistracted": "get distracted",
    "airconditioning": "air conditioning",
    "forconsuming": "for consuming",
    "believethat": "believe that",
    "quietcuriosity": "quiet curiosity",
    "globalconflict": "global conflict",
    "tastesgood": "tastes good",
    "localfood": "local food",
    "spacecommunity": "space community",
    "butgetting": "but getting",
    "theground": "the ground",
    "spacestation": "space station",
    "certainlyuncertainty": "certainly uncertainty",
    "areessentially": "are essentially",
    "youprobably": "you probably",
    "birdsanctuaries": "bird sanctuaries",
    "hundredand": "hundred and",
    "thenineteen": "the nineteen",
    "couldpick": "could pick",
    "startgetting": "start getting",
    "thatexists": "that exists",
    "aquaticplants": "aquatic plants",
    "goodgamer": "good gamer",
    "sciencefiction": "science fiction",
    "stepinstructions": "step instructions",
    "howhappily": "how happily",
    "theability": "the ability",
    "aboutright": "about right",
    "picturehere": "picture here",
    "everysprig": "every sprig",
    "theseconversations": "these conversations",
    "justdeveloped": "just developed",
    "onlinegames": "online games",
    "withtheir": "with their",
    "discussedbroadly": "discussed broadly",
    "justkeeping": "just keeping",
    "romantickind": "romantic kind",
    "environmentand": "environment and",
    "conductedabout": "conducted about",
    "reasonablepeople": "reasonable people",
    "seeingcreatures": "seeing creatures",
    "knownabout": "known about",
    "weredifferent": "were different",
    "forbetter": "for better",
    "thelocation": "the location",
    "lowenergy": "low energy",
    "anddoctor": "and doctor",
    "diseasecomes": "disease comes",
    "thefuture": "the future",
    "betterlives": "better lives",
    "breadbasket": "bread basket",
    "withamazing": "with amazing",
    "hikingand": "hiking and",
    "imagedthem": "imaged them",
    "everymorning": "every morning",
    "superimportant": "super important",
    "canexpect": "can expect",
    "careabout": "care about",
    "worldtoday": "world today",
    "rightthere": "right there",
    "beenplaying": "been playing",
    "whathappens": "what happens",
    "exerciseand": "exercise and",
    "noteconomically": "not economically",
    "withincome": "with income",
    "startedplaying": "started playing",
    "somethingthat": "something that",
    "twentyyears": "twenty years",
    "fourwords": "four words",
    "deepocean": "deep ocean",
    "gettingmore": "getting more",
    "andtreating": "and treating",
    "thepopulation": "the population",
    "mathclass": "math class",
    "titanicand": "titanic and",
    "moreabout": "more about",
    "sixbillion": "six billion",
    "everyyear": "every year",
    "playinggames": "playing games",
    "basedsystem": "based system",
    "greataccomplishments": "great accomplishments",
    "canignite": "can ignite",
    "designstuff": "design stuff",
    "overeating": "over eating",
    "wherepain": "where pain",
    "rightthey": "right they",
    "thepenguins": "the penguins",
    "achievemore": "achieve more",
    "peoplewill": "people will",
    "whatshould": "what should",
    "birdsanctuary": "bird sanctuary",
    "simpleploy": "simple ploy",
    "primatehuman": "primate human",
    "ninebillion": "nine billion",
    "liquidmetal": "liquid metal",
    "thevirtual": "the virtual",
    "energyand": "energy and",
    "themedical": "the medical",
    "becausethey": "because they",
    "handmoves": "hand moves",
    "thechildren": "the children",
    "withscience": "with science",
    "downthere": "down there",
    "thebusiness": "the business",
    "fivetimes": "five times",
    "workingwith": "working with",
    "evergrowing": "ever growing",
    "undernear": "under near",
    "knowheart": "know heart",
    "couldthat": "could that",
    "thirtyyears": "thirty years",
    "garlicand": "garlic and",
    "teddinners": "ted dinners",
    "theyexisted": "they existed",
    "happypeople": "happy people",
    "justabout": "just about",
    "freestanding": "free standing",
    "planetthe": "planet the",
    "effectbut": "effect but",
    "worldchanging": "world changing",
    "hundredmillion": "hundred million",
    "smallteam": "small team",
    "theinstitute": "the institute",
    "admitcomplexity": "admit complexity",
    "fourthfactor": "fourth factor",
    "violinlesson": "violin lesson",
    "castshadows": "cast shadows",
    "manyyears": "many years",
    "somethingand": "something and",
    "humanability": "human ability",
    "termmiracle": "term miracle",
    "searchhistory": "search history",
    "traineddouble": "trained double",
    "knifetrick": "knife trick",
    "broughtback": "brought back",
    "ownchoosing": "own choosing",
    "cometogether": "come together",
    "backstageand": "backstage and",
    "temperaturewill": "temperature will",
    "gamechanges": "game changes",
    "thesource": "the source",
    "canachieve": "can achieve",
    "fiftyyears": "fifty years",
    "theinternational": "the international",
    "wellbeing": "well being",
    "otherpeople": "other people",
    "wishfulthinking": "wishful thinking",
    "deathnumber": "death number",
    "anyoneeven": "anyone even",
    "learningabout": "learning about",
    "problemsolvers": "problem solvers",
    "activeand": "active and",
    "farmsthat": "farms that",
    "massdestruction": "mass destruction",
    "aboutpoint": "about point",
    "gameworlds": "game worlds",
    "andperhaps": "and perhaps",
    "passagework": "passage work",
    "amongstothers": "amongst others",
    "darkenyour": "darken your",
    "areactual": "are actual",
    "longbeach": "long beach",
    "thepursuit": "the pursuit",
    "reasonsare": "reasons are",
    "groupedtogether": "grouped together",
    "firstthing": "first thing",
    "coolingpools": "cooling pools",
    "foodproblem": "food problem",
    "thekingdom": "the kingdom",
    "notnecessarily": "not necessarily",
    "differenttypes": "different types",
    "anddiving": "and diving",
    "problemwith": "problem with",
    "andabsolutely": "and absolutely",
    "lowerthat": "lower that",
    "birdpopulation": "bird population",
    "theglobal": "the global",
    "eightthousand": "eight thousand",
    "everyevening": "every evening",
    "themajority": "the majority",
    "theirabilities": "their abilities",
    "ninetypercent": "ninety percent",
    "themoving": "the moving",
    "epicmission": "epic mission",
    "somepeople": "some people",
    "productionand": "production and",
    "moregamers": "more gamers",
    "themineral": "the mineral",
    "justthrough": "just through",
    "themagnitude": "the magnitude",
    "potablewater": "potable water",
    "gettingconfused": "getting confused",
    "scubadiver": "scuba diver",
    "doingthis": "doing this",
    "everydaylife": "everyday life",
    "differentapproach": "different approach",
    "safetynet": "safety net",
    "governmentofficial": "government official",
    "beenchanged": "been changed",
    "wouldpower": "would power",
    "higheststandards": "highest standards",
    "storythis": "story this",
    "littlebit": "little bit",
    "fivepoint": "five point",
    "foreveryone": "for everyone",
    "theaudience": "the audience",
    "drycasking": "dry casking",
    "whetherthey": "whether they",
    "whatabout": "what about",
    "trustthat": "trust that",
    "afraidthat": "afraid that",
    "thedestruction": "the destruction",
    "fishmeals": "fish meals",
    "bismarkand": "bismark and",
    "everyweek": "every week",
    "thecivilization": "the civilization",
    "flippedthe": "flipped the",
    "everysixty": "every sixty",
    "theproblem": "the problem",
}

def normalize_text(text, mappings):
    # 替换连接词组
    for wrong, correct in mappings.items():
        text = text.replace(wrong, correct)
    # 转小写、去标点
    text = text.lower()
    text = re.sub(r"[^\w\s]", "", text)
    return text.split()

def calculate_wer(ref, hyp):
    # Levenshtein距离计算WER
    r_len = len(ref)
    d = [[0] * (len(hyp) + 1) for _ in range(r_len + 1)]
    for i in range(r_len + 1):
        d[i][0] = i
    for j in range(len(hyp) + 1):
        d[0][j] = j
    for i in range(1, r_len + 1):
        for j in range(1, len(hyp) + 1):
            cost = 0 if ref[i - 1] == hyp[j - 1] else 1
            d[i][j] = min(
                d[i - 1][j] + 1,     # 删除
                d[i][j - 1] + 1,     # 插入
                d[i - 1][j - 1] + cost  # 替换
            )
    return d[-1][-1] / r_len

def main():
    # 路径可修改为你的文件位置
    ref_path = "/scratch/s5836670/TEDLIUM_release2/wer/own/reftext.txt"
    hyp_path = "/scratch/s5836670/TEDLIUM_release2/wer/own/asrfinal_lower.txt"

    with open(ref_path, "r", encoding="utf-8") as f:
        ref_text = f.read()
    with open(hyp_path, "r", encoding="utf-8") as f:
        hyp_text = f.read()

    # 文本标准化
    ref_words = normalize_text(ref_text, {})  # ref不替换
    hyp_words = normalize_text(hyp_text, custom_mappings)

    # 计算 WER
    wer = calculate_wer(ref_words, hyp_words)
    print(f"WER: {wer:.4f}")

if __name__ == "__main__":
    main()
